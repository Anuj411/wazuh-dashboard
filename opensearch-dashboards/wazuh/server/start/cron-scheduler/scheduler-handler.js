"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.jobSchedulerRun = jobSchedulerRun;

var _index = require("./index");

var _configuredJobs = require("./configured-jobs");

var _logger = require("../../lib/logger");

var _getConfiguration = require("../../lib/get-configuration");

var _nodeCron = _interopRequireDefault(require("node-cron"));

var _constants = require("../../../common/constants");

var _statisticsTemplate = require("../../integration-files/statistics-template");

var _utils = require("../../../common/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const blueWazuh = '\u001b[34mwazuh\u001b[39m';
const schedulerErrorLogColors = [blueWazuh, 'scheduler', 'error'];
const schedulerJobs = [];
/**
* Wait until Kibana server is ready
*/

const checkPluginPlatformStatus = async function (context) {
  try {
    (0, _logger.log)('scheduler-handler:checkPluginPlatformStatus', 'Waiting for Kibana and Elasticsearch servers to be ready...', 'debug');
    await checkElasticsearchServer(context);
    await checkTemplate(context);
    return;
  } catch (error) {
    (0, _logger.log)('scheduler-handler:checkPluginPlatformStatus', error.mesage || error);

    try {
      await (0, _utils.delayAsPromise)(3000);
      await checkPluginPlatformStatus(context);
    } catch (error) {}

    ;
  }
};
/**
 * Check Elasticsearch Server status and Kibana index presence
 */


const checkElasticsearchServer = async function (context) {
  try {
    const data = await context.core.opensearch.client.asInternalUser.indices.exists({
      index: context.server.config.opensearchDashboards.index
    });
    return data.body;
  } catch (error) {
    (0, _logger.log)('scheduler-handler:checkElasticsearchServer', error.message || error);
    return Promise.reject(error);
  }
};
/**
* Verify wazuh-statistics template
*/


const checkTemplate = async function (context) {
  try {
    (0, _logger.log)('scheduler-handler:checkTemplate', 'Updating the statistics template', 'debug');
    const appConfig = await (0, _getConfiguration.getConfiguration)();
    const prefixTemplateName = appConfig['cron.prefix'] || _constants.WAZUH_STATISTICS_DEFAULT_PREFIX;
    const statisticsIndicesTemplateName = appConfig['cron.statistics.index.name'] || _constants.WAZUH_STATISTICS_DEFAULT_NAME;
    const pattern = `${prefixTemplateName}-${statisticsIndicesTemplateName}-*`;

    try {
      // Check if the template already exists
      const currentTemplate = await context.core.opensearch.client.asInternalUser.indices.getTemplate({
        name: _constants.WAZUH_STATISTICS_TEMPLATE_NAME
      }); // Copy already created index patterns

      _statisticsTemplate.statisticsTemplate.index_patterns = currentTemplate.body[_constants.WAZUH_STATISTICS_TEMPLATE_NAME].index_patterns;
    } catch (error) {
      // Init with the default index pattern
      _statisticsTemplate.statisticsTemplate.index_patterns = [pattern];
    } // Check if the user is using a custom pattern and add it to the template if it does


    if (!_statisticsTemplate.statisticsTemplate.index_patterns.includes(pattern)) {
      _statisticsTemplate.statisticsTemplate.index_patterns.push(pattern);
    }

    ; // Update the statistics template

    await context.core.opensearch.client.asInternalUser.indices.putTemplate({
      name: _constants.WAZUH_STATISTICS_TEMPLATE_NAME,
      body: _statisticsTemplate.statisticsTemplate
    });
    (0, _logger.log)('scheduler-handler:checkTemplate', 'Updated the statistics template', 'debug');
  } catch (error) {
    const errorMessage = `Something went wrong updating the statistics template ${error.message || error}`;
    (0, _logger.log)('scheduler-handler:checkTemplate', errorMessage);
    context.wazuh.logger.error(schedulerErrorLogColors, errorMessage);
    throw error;
  }
};

async function jobSchedulerRun(context) {
  // Check Kibana index and if it is prepared, start the initialization of Wazuh App.
  await checkPluginPlatformStatus(context);

  for (const job in (0, _configuredJobs.configuredJobs)({})) {
    const schedulerJob = new _index.SchedulerJob(job, context);
    schedulerJobs.push(schedulerJob);

    const task = _nodeCron.default.schedule(_index.jobs[job].interval, () => schedulerJob.run());
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjaGVkdWxlci1oYW5kbGVyLnRzIl0sIm5hbWVzIjpbImJsdWVXYXp1aCIsInNjaGVkdWxlckVycm9yTG9nQ29sb3JzIiwic2NoZWR1bGVySm9icyIsImNoZWNrUGx1Z2luUGxhdGZvcm1TdGF0dXMiLCJjb250ZXh0IiwiY2hlY2tFbGFzdGljc2VhcmNoU2VydmVyIiwiY2hlY2tUZW1wbGF0ZSIsImVycm9yIiwibWVzYWdlIiwiZGF0YSIsImNvcmUiLCJvcGVuc2VhcmNoIiwiY2xpZW50IiwiYXNJbnRlcm5hbFVzZXIiLCJpbmRpY2VzIiwiZXhpc3RzIiwiaW5kZXgiLCJzZXJ2ZXIiLCJjb25maWciLCJvcGVuc2VhcmNoRGFzaGJvYXJkcyIsImJvZHkiLCJtZXNzYWdlIiwiUHJvbWlzZSIsInJlamVjdCIsImFwcENvbmZpZyIsInByZWZpeFRlbXBsYXRlTmFtZSIsIldBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9QUkVGSVgiLCJzdGF0aXN0aWNzSW5kaWNlc1RlbXBsYXRlTmFtZSIsIldBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9OQU1FIiwicGF0dGVybiIsImN1cnJlbnRUZW1wbGF0ZSIsImdldFRlbXBsYXRlIiwibmFtZSIsIldBWlVIX1NUQVRJU1RJQ1NfVEVNUExBVEVfTkFNRSIsInN0YXRpc3RpY3NUZW1wbGF0ZSIsImluZGV4X3BhdHRlcm5zIiwiaW5jbHVkZXMiLCJwdXNoIiwicHV0VGVtcGxhdGUiLCJlcnJvck1lc3NhZ2UiLCJ3YXp1aCIsImxvZ2dlciIsImpvYlNjaGVkdWxlclJ1biIsImpvYiIsInNjaGVkdWxlckpvYiIsIlNjaGVkdWxlckpvYiIsInRhc2siLCJjcm9uIiwic2NoZWR1bGUiLCJqb2JzIiwiaW50ZXJ2YWwiLCJydW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLFNBQVMsR0FBRywyQkFBbEI7QUFDQSxNQUFNQyx1QkFBdUIs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QUFJLEVBQUVDLHlDQURnRTtBQUV0RWIsTUFBQUEsSUFBSSxFQUFFYztBQUZnRSxLQUFsRSxDQUFOO0FBSUEscUJBQ0UsaUNBREYsRUFFRSxpQ0FGRixFQUdFLE9BSEY7QUFLRCxHQXZDRCxDQXVDRSxPQUFPM0IsS0FBUCxFQUFjO0FBQ2QsVUFBTWdDLFlBQVksR0FBSSx5REFBd0RoQyxLQUFLLENBQUNjLE9BQU4sSUFBaUJkLEtBQU0sRUFBckc7QUFDQSxxQkFDRSxpQ0FERixFQUVFZ0MsWUFGRjtBQUlBbkMsSUFBQUEsT0FBTyxDQUFDb0MsS0FBUixDQUFjQyxNQUFkLENBQXFCbEMsS0FBckIsQ0FBMkJOLHVCQUEzQixFQUFvRHNDLFlBQXBEO0FBQ0EsVUFBTWhDLEtBQU47QUFDRDtBQUNGLENBakREOztBQW1ETyxlQUFlbUMsZUFBZixDQUErQnRDLE9BQS9CLEVBQXVDO0FBQzVDO0FBQ0EsUUFBTUQseUJBQXlCLENBQUNDLE9BQUQsQ0FBL0I7O0FBQ0EsT0FBSyxNQUFNdUMsR0FBWCxJQUFrQixvQ0FBZSxFQUFmLENBQWxCLEVBQXNDO0FBQ3BDLFVBQU1DLFlBQTBCLEdBQUcsSUFBSUMsbUJBQUosQ0FBaUJGLEdBQWpCLEVBQXNCdkMsT0FBdEIsQ0FBbkM7QUFDQUYsSUFBQUEsYUFBYSxDQUFDbUMsSUFBZCxDQUFtQk8sWUFBbkI7O0FBQ0EsVUFBTUUsSUFBSSxHQUFHQyxrQkFBS0MsUUFBTCxDQUNYQyxZQUFLTixHQUFMLEVBQVVPLFFBREMsRUFFWCxNQUFNTixZQUFZLENBQUNPLEdBQWIsRUFGSyxDQUFiO0FBSUQ7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGpvYnMsIFNjaGVkdWxlckpvYiB9IGZyb20gJy4vaW5kZXgnO1xuaW1wb3J0IHsgY29uZmlndXJlZEpvYnMgfSBmcm9tICcuL2NvbmZpZ3VyZWQtam9icyc7XG5pbXBvcnQgeyBsb2cgfSBmcm9tICcuLi8uLi9saWIvbG9nZ2VyJztcbmltcG9ydCB7IGdldENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi9saWIvZ2V0LWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IGNyb24gZnJvbSAnbm9kZS1jcm9uJztcbmltcG9ydCB7IFdBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9QUkVGSVgsIFdBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9OQU1FLCBXQVpVSF9TVEFUSVNUSUNTX1RFTVBMQVRFX05BTUUgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vY29uc3RhbnRzJztcbmltcG9ydCB7IHN0YXRpc3RpY3NUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2ludGVncmF0aW9uLWZpbGVzL3N0YXRpc3RpY3MtdGVtcGxhdGUnO1xuaW1wb3J0IHsgZGVsYXlBc1Byb21pc2UgfSBmcm9tICcuLi8uLi8uLi9jb21tb24vdXRpbHMnO1xuXG5jb25zdCBibHVlV2F6dWggPSAnXFx1MDAxYlszNG13YXp1aFxcdTAwMWJbMzltJztcbmNvbnN0IHNjaGVkdWxlckVycm9yTG9nQ29sb3JzID0gW2JsdWVXYXp1aCwgJ3NjaGVkdWxlcicsICdlcnJvciddO1xuY29uc3Qgc2NoZWR1bGVySm9icyA9IFtdO1xuXG4vKipcbiogV2FpdCB1bnRpbCBLaWJhbmEgc2VydmVyIGlzIHJlYWR5XG4qL1xuY29uc3QgY2hlY2tQbHVnaW5QbGF0Zm9ybVN0YXR1cyA9IGFzeW5jIGZ1bmN0aW9uIChjb250ZXh0KSB7XG4gIHRyeSB7XG4gICAgIGxvZyhcbiAgICAgICAnc2NoZWR1bGVyLWhhbmRsZXI6Y2hlY2tQbHVnaW5QbGF0Zm9ybVN0YXR1cycsXG4gICAgICAgJ1dhaXRpbmcgZm9yIEtpYmFuYSBhbmQgRWxhc3RpY3NlYXJjaCBzZXJ2ZXJzIHRvIGJlIHJlYWR5Li4uJyxcbiAgICAgICAnZGVidWcnXG4gICAgICk7XG5cbiAgICBhd2FpdCBjaGVja0VsYXN0aWNzZWFyY2hTZXJ2ZXIoY29udGV4dCk7XG4gICAgYXdhaXQgY2hlY2tUZW1wbGF0ZShjb250ZXh0KTtcbiAgICByZXR1cm47XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgIGxvZyhcbiAgICAgICAnc2NoZWR1bGVyLWhhbmRsZXI6Y2hlY2tQbHVnaW5QbGF0Zm9ybVN0YXR1cycsXG4gICAgICAgZXJyb3IubWVzYWdlIHx8ZXJyb3JcbiAgICAgKTtcbiAgICAgdHJ5e1xuICAgICAgIGF3YWl0IGRlbGF5QXNQcm9taXNlKDMwMDApO1xuICAgICAgIGF3YWl0IGNoZWNrUGx1Z2luUGxhdGZvcm1TdGF0dXMoY29udGV4dCk7XG4gICAgIH1jYXRjaChlcnJvcil7fTtcbiAgfVxuIH1cblxuXG4gLyoqXG4gICogQ2hlY2sgRWxhc3RpY3NlYXJjaCBTZXJ2ZXIgc3RhdHVzIGFuZCBLaWJhbmEgaW5kZXggcHJlc2VuY2VcbiAgKi9cbiBjb25zdCBjaGVja0VsYXN0aWNzZWFyY2hTZXJ2ZXIgPSBhc3luYyBmdW5jdGlvbiAoY29udGV4dCkge1xuICAgdHJ5IHtcbiAgICAgY29uc3QgZGF0YSA9IGF3YWl0IGNvbnRleHQuY29yZS5vcGVuc2VhcmNoLmNsaWVudC5hc0ludGVybmFsVXNlci5pbmRpY2VzLmV4aXN0cyh7XG4gICAgICAgaW5kZXg6IGNvbnRleHQuc2VydmVyLmNvbmZpZy5vcGVuc2VhcmNoRGFzaGJvYXJkcy5pbmRleFxuICAgICB9KTtcblxuICAgICByZXR1cm4gZGF0YS5ib2R5O1xuICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgbG9nKCdzY2hlZHVsZXItaGFuZGxlcjpjaGVja0VsYXN0aWNzZWFyY2hTZXJ2ZXInLCBlcnJvci5tZXNzYWdlIHx8IGVycm9yKTtcbiAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGVycm9yKTtcbiAgIH1cbiB9XG5cblxuIC8qKlxuICogVmVyaWZ5IHdhenVoLXN0YXRpc3RpY3MgdGVtcGxhdGVcbiAqL1xuY29uc3QgY2hlY2tUZW1wbGF0ZSA9IGFzeW5jIGZ1bmN0aW9uIChjb250ZXh0KSB7XG4gIHRyeSB7XG4gICAgbG9nKFxuICAgICAgJ3NjaGVkdWxlci1oYW5kbGVyOmNoZWNrVGVtcGxhdGUnLFxuICAgICAgJ1VwZGF0aW5nIHRoZSBzdGF0aXN0aWNzIHRlbXBsYXRlJyxcbiAgICAgICdkZWJ1ZydcbiAgICApO1xuXG4gICAgY29uc3QgYXBwQ29uZmlnID0gYXdhaXQgZ2V0Q29uZmlndXJhdGlvbigpO1xuICAgIGNvbnN0IHByZWZpeFRlbXBsYXRlTmFtZSA9IGFwcENvbmZpZ1snY3Jvbi5wcmVmaXgnXSB8fCBXQVpVSF9TVEFUSVNUSUNTX0RFRkFVTFRfUFJFRklYO1xuICAgIGNvbnN0IHN0YXRpc3RpY3NJbmRpY2VzVGVtcGxhdGVOYW1lID0gYXBwQ29uZmlnWydjcm9uLnN0YXRpc3RpY3MuaW5kZXgubmFtZSddIHx8IFdBWlVIX1NUQVRJU1RJQ1NfREVGQVVMVF9OQU1FO1xuICAgIGNvbnN0IHBhdHRlcm4gPSBgJHtwcmVmaXhUZW1wbGF0ZU5hbWV9LSR7c3RhdGlzdGljc0luZGljZXNUZW1wbGF0ZU5hbWV9LSpgO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIHRoZSB0ZW1wbGF0ZSBhbHJlYWR5IGV4aXN0c1xuICAgICAgY29uc3QgY3VycmVudFRlbXBsYXRlID0gYXdhaXQgY29udGV4dC5jb3JlLm9wZW5zZWFyY2guY2xpZW50LmFzSW50ZXJuYWxVc2VyLmluZGljZXMuZ2V0VGVtcGxhdGUoe1xuICAgICAgICBuYW1lOiBXQVpVSF9TVEFUSVNUSUNTX1RFTVBMQVRFX05BTUVcbiAgICAgIH0pO1xuICAgICAgLy8gQ29weSBhbHJlYWR5IGNyZWF0ZWQgaW5kZXggcGF0dGVybnNcbiAgICAgIHN0YXRpc3RpY3NUZW1wbGF0ZS5pbmRleF9wYXR0ZXJucyA9IGN1cnJlbnRUZW1wbGF0ZS5ib2R5W1dBWlVIX1NUQVRJU1RJQ1NfVEVNUExBVEVfTkFNRV0uaW5kZXhfcGF0dGVybnM7XG4gICAgfWNhdGNoIChlcnJvcikge1xuICAgICAgLy8gSW5pdCB3aXRoIHRoZSBkZWZhdWx0IGluZGV4IHBhdHRlcm5cbiAgICAgIHN0YXRpc3RpY3NUZW1wbGF0ZS5pbmRleF9wYXR0ZXJucyA9IFtwYXR0ZXJuXTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiB0aGUgdXNlciBpcyB1c2luZyBhIGN1c3RvbSBwYXR0ZXJuIGFuZCBhZGQgaXQgdG8gdGhlIHRlbXBsYXRlIGlmIGl0IGRvZXNcbiAgICBpZiAoIXN0YXRpc3RpY3NUZW1wbGF0ZS5pbmRleF9wYXR0ZXJucy5pbmNsdWRlcyhwYXR0ZXJuKSkge1xuICAgICAgc3RhdGlzdGljc1RlbXBsYXRlLmluZGV4X3BhdHRlcm5zLnB1c2gocGF0dGVybik7XG4gICAgfTtcblxuICAgIC8vIFVwZGF0ZSB0aGUgc3RhdGlzdGljcyB0ZW1wbGF0ZVxuICAgIGF3YWl0IGNvbnRleHQuY29yZS5vcGVuc2VhcmNoLmNsaWVudC5hc0ludGVybmFsVXNlci5pbmRpY2VzLnB1dFRlbXBsYXRlKHtcbiAgICAgIG5hbWU6IFdBWlVIX1NUQVRJU1RJQ1NfVEVNUExBVEVfTkFNRSxcbiAgICAgIGJvZHk6IHN0YXRpc3RpY3NUZW1wbGF0ZVxuICAgIH0pO1xuICAgIGxvZyhcbiAgICAgICdzY2hlZHVsZXItaGFuZGxlcjpjaGVja1RlbXBsYXRlJyxcbiAgICAgICdVcGRhdGVkIHRoZSBzdGF0aXN0aWNzIHRlbXBsYXRlJyxcbiAgICAgICdkZWJ1ZydcbiAgICApO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBTb21ldGhpbmcgd2VudCB3cm9uZyB1cGRhdGluZyB0aGUgc3RhdGlzdGljcyB0ZW1wbGF0ZSAke2Vycm9yLm1lc3NhZ2UgfHwgZXJyb3J9YDtcbiAgICBsb2coXG4gICAgICAnc2NoZWR1bGVyLWhhbmRsZXI6Y2hlY2tUZW1wbGF0ZScsXG4gICAgICBlcnJvck1lc3NhZ2VcbiAgICApO1xuICAgIGNvbnRleHQud2F6dWgubG9nZ2VyLmVycm9yKHNjaGVkdWxlckVycm9yTG9nQ29sb3JzLCBlcnJvck1lc3NhZ2UpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBqb2JTY2hlZHVsZXJSdW4oY29udGV4dCl7XG4gIC8vIENoZWNrIEtpYmFuYSBpbmRleCBhbmQgaWYgaXQgaXMgcHJlcGFyZWQsIHN0YXJ0IHRoZSBpbml0aWFsaXphdGlvbiBvZiBXYXp1aCBBcHAuXG4gIGF3YWl0IGNoZWNrUGx1Z2luUGxhdGZvcm1TdGF0dXMoY29udGV4dCk7XG4gIGZvciAoY29uc3Qgam9iIGluIGNvbmZpZ3VyZWRKb2JzKHt9KSkge1xuICAgIGNvbnN0IHNjaGVkdWxlckpvYjogU2NoZWR1bGVySm9iID0gbmV3IFNjaGVkdWxlckpvYihqb2IsIGNvbnRleHQpO1xuICAgIHNjaGVkdWxlckpvYnMucHVzaChzY2hlZHVsZXJKb2IpO1xuICAgIGNvbnN0IHRhc2sgPSBjcm9uLnNjaGVkdWxlKFxuICAgICAgam9ic1tqb2JdLmludGVydmFsLFxuICAgICAgKCkgPT4gc2NoZWR1bGVySm9iLnJ1bigpLFxuICAgICk7XG4gIH1cbn1cbiJdfQ==